<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/common/bootstrap-3.3.7/css/bootstrap.css" />
    <link rel="stylesheet" href="/common/fontawesome/font-awesome.css" />
    <link rel="stylesheet" href="/common/bootstrap-table/src/bootstrap-table.css" type="text/css"  />
    <link rel="stylesheet" href="/common/bootstrap3-editable/css/bootstrap-editable.css" type="text/css"  />
    <script type="text/javascript" src="/common/js/jquery/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/common/artDialog4.1.6/jquery.artDialog.js?skin=idialog"></script>
    <script type="text/javascript" src="/common/artDialog4.1.6/plugins/iframeTools.js"></script>
    <script type="text/javascript" src="/common/js/jquery/jquery.extends.js"></script>
    <script type="text/javascript" src="/common/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/common/bootstrap3-editable/js/bootstrap-editable.js"></script>
    <script type="text/javascript" src="/common/bootstrap-table/src/bootstrap-table.js"></script>
    <script type="text/javascript" src="/common/bootstrap-table/src/locale/bootstrap-table-zh-CN.js"></script>
    <script type="text/javascript" src="/common/js/share/share.js"></script>
    <script type="text/javascript" src="/common/js/share/bootstrap-table-default.js"></script>
    <script type="text/javascript" src="/common/bootstrap-table/src/extensions/filter-control/bootstrap-table-filter-control.js"></script>
    <script type="text/javascript" src="/common/bootstrap-table/src/extensions/filter/bootstrap-table-filter.js"></script>
    <script type="text/javascript" src="/common/bootstrap-table/src/extensions/editable/bootstrap-table-editable.js"></script>
    <script type="text/javascript" src="/common/auto/j.autocomplete.js"></script>
    <style type="text/css">
        .sediv{
            display: block;
            position: absolute;
            margin-left: 60px;
            background: blue;
            height: 44px;
            width: 167px;
            padding: 5px;
        }
        .ac_results{
            background:#f3f3f3;
            overflow: auto;
        }
        textarea.form-control,.editableform textarea.form-control{
            width: 628px;
            height: 202px;
        }
    </style>
</head>
<body>
<!-- 头部 -->
<div class="header">

</div>
<div id="container" class="container-fluid">
    <div class="w1200" id="pagePad">
        <div class="h1_title">
            <h1 class="fl">查询信息</h1>
        </div>
        <!-- 主题信息 -->
        <div class="fs_box">
            <div class="form-inline" style="margin-top:15px;">
                <div class="form-group">
                    <label class="control-label">选择表名</label>
                    <input class="form-control" type="text" id="autoid" placeholder="双击或者输入内容"  style="width: 351px;"/>
                    <button class="btn btn-default">
                        <i class="icon-share" id="clearid">清空</i>
                    </button>
                </div>
            </div>
            <div class="form-inline" id="tablesearcformid" style="margin-top:15px;">
                <div class="form-group">
                    <label class="control-label">表名</label>
                    <input class="form-control" type="text" id="tablenameid"  />
                    <!-- 显示表名称 -->
                    <div class="sediv" id="tableInfoOptionID" style="display:none;">
                        <select class="form-control" id="tableSelectID">
                            <option value=""></option>
                            <option value="S_BASECOLUMN_CONFIG">属性基本信息</option>
                            <option value="S_BASETABLE_CONFIG">表配置信息</option>
                            <option value="S_MANAGER_SQLINFO">SQL表管理信息</option>
                            <option value="S_MODAL_CONFIG">多种模板信息</option>
                            <option value="S_MODAL_TYPE">模板主结构配置</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">表ID</label>
                    <input class="form-control" type="text" id="tableid"  />
                </div>
                <div class="form-group">
                    <label class="control-label">主键</label>
                    <input class="form-control" type="text" id="keyid" name="keyid"/>
                </div>
                <div class="form-group">
                    <label class="control-label">全部展现</label>
                    <select class="form-control"  id="isallsearchid">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="control-label">全部模糊</label>
                    <select class="form-control"  id="isAllLike">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
                <button class="btn btn-default">
                    <i class="icon-share" id="tablesearchID">查询</i>
                </button>
            </div>
            <div class="form-inline" id="searcformid" style="margin-top:15px;">
                <div class="form-group">
                    <label class="control-label">字段名称</label>
                    <input class="form-control" type="text"  name=""/>
                </div>
                <button class="btn btn-default">
                    <i class="icon-share" id="searchID">查询</i>
                </button>
            </div>
            <div id="toolbar">
                <button class="btn btn-default">
                    <i class="glyphicon glyphicon-plus" id="addARowID"></i>
                </button>
                <button class="btn btn-default">
                    <i class="glyphicon glyphicon-heart" id="heartBtn"></i>
                </button>
                <button class="btn btn-default" id="bathDel">
                    <i class="glyphicon glyphicon-trash" ></i>
                </button>
                <!-- 批量保存 -->
                <button class="btn btn-default">
                    <i class="icon-share" id="bathSaveid">修改保存</i>
                </button>
                <button class="btn btn-default">
                    <i class="icon-share" id="addSaveID">新增保存</i>
                </button>
            </div>
            <table id="boot_table"
                   data-toolbar="#toolbar"
                   data-striped="true"
                   data-toggle="table"
                   data-search="true"
                   data-show-refresh="true"
                   data-show-toggle="true"
                   data-show-columns="true"
                   data-select-item-name="item"
                   data-filter-control="false"
                   data-filter-Show-Clear="false"
                   data-method="post"
                   data-unique-id="ID"
                   data-sort-name="ID"
                   data-sort-order="desc"
                   data-pagination = "true"
                   data-side-pagination = "server"
                   data-page-size="10"
                   data-page-number="1"
                   data-click-to-select="true"
                   data-query-params="queryParam"
                   data-content-type="application/x-www-form-urlencoded"
                   data-onEditableSave="saveInfo"
            >
                <!-- data-editable="true"
                    data-editable-url="/my/editable/update/path" -->
                <!-- <thead>
                 <tr>
                     <th data-field="NM" data-align="center" data-visible="false" data-sortable="true" data-filter-control="input">历史Id</th>
                     <th data-field="NM" data-width="50px" data-align="center" data-visible="true" data-checkbox="true" data-formatter="checkboxProcess"></th>
                     <th data-field="RN" data-width="50px" data-align="center" data-visible="true">序号</th>
                     <th data-field="COLUMNENAME" data-align="center" data-visible="true">英文名称</th>
                     <th data-field="COLUMNNAME" data-align="center" data-visible="true">中文名称</th>
                     <th data-field="MODIFYDISPLAY" data-align="center" data-visible="true"  data-editable="true" data-type="text" data-title="修改是否显示">修改是否显示</th>
                     <th data-field="DWMC" data-align="center" data-visible="true">单位</th>
                     <th data-field="JRZBYXM" data-align="center" data-visible="true" data-editable="true" data-type="text" data-title="今日值班参谋" >今日值班参谋</th>
                     <th data-field="MRZBYXM" data-align="center" data-visible="true" >明日值班参谋</th>
                     <th data-field="kssj" data-align="center" data-visible="true" data-formatter="qk_table_all">处置情况</th>
                    </tr>
              </thead>   -->
            </table>
        </div>
    </div>
</div>

</body>
<script>
    var basePath='';
    $(function () {
        $('.header').load('/head/header');
        initAutocomplete();
        $('#tablesearchID').click(function(){
            if($('#tablenameid').val()==''){
                $.alert('请输入表名');
                return ;
            }else{
                initsearch();
                $('#searchID').click();
                //$(divTree).hide();
            }
        });
        $('#clearid').click(function(){
            $("#autoid").val('');
        });
        //获取div
        /* var divTree=$('#tablenameid').next('div');
        $('#tablenameid').focus(function(){
            $(divTree).show();
        });
        $('#tablenameid').blur(function(){
            //$(divTree).hide();
        });
        $('#tableSelectID').bind('change',function(){
            $('#tablenameid').val($('#tableSelectID').val());
            $(divTree).hide();
        }); */
    });
    //初始化表名
    function initAutocomplete(){
        var condition={tablenameLike:$("#autoid").val()};
        var data={};
        data['condition']=JSON.stringify(condition);
        data['typename']='S_BASETABLE_CONFIG';
        $("#autoid").autocomplete(basePath+'/share/findList', {
            minChars: 0,
            width: 277,
            height: 280,
            delay: 800,
            matchContains: false,
            autoFill: false,
            multiple: false,
            // multipleSeparator: ",",
            mustMatch:true,//只显示匹配内容
            //scrollHeight:true,
            // 多选时候的分隔符 默认为“，”
            dataType: "json",
            scroll: true,
            extraParams:{
                condition:function(){return JSON.stringify({tablenameLike:$("#autoid").val()});},
                typename:'S_BASETABLE_CONFIG'
            },
            // 返回的结果集为JSON数据
            parse: function (data) {
                return $.map(data.result, function (row) {
                    return {
                        data: row,
                        value: row.TABLENAME+row.TABLEENAME,
                        result: row.TABLENAME
                    };
                });
            },
            formatItem: function (row, i, max) {
                // $.tips.close();
                // 显示下拉列表的内容
                return row.TABLENAME+'-'+row.ID;
            },
            formatResult: function (row) {
                return row.TABLENAME;
            }
        }).result(function (e, item) {
            if(item&&item.TABLEENAME&&item.ID){
                // 将结果同时输入到
                $("#tablenameid").val(item.TABLEENAME);
                $("#tableid").val(item.ID);
            }
        });
    }
    function initsearch(){
        var cols=initInfo();
        /* $("#boot_table").bootstrapTable('refreshOptions',{
             columns:cols
        }); */

        /* $("#boot_table").bootstrapTable({
             columns:cols
        });   */
        $("#boot_table").on('uncheck.bs.table check.bs.table check-all.bs.table uncheck-all.bs.table',function(e,row){
            //examine(e.type,datas);
            console.log();
        });
        $('#bathSaveid').unbind('click').bind('click',function(){
            modifyInfo();
        });
        $('#addSaveID').unbind('click').bind('click',function(){
            addSaveInfo();
        });
        $('#bathDel').unbind('click').bind('click',function(){
            delBath();
        });
        var datas={};
        /* $.each(cols,function(index,item){
            datas[item.field]='';
        }); */

        $('#addARowID').unbind('click').bind('click',function(){
            var selects=$("#boot_table").bootstrapTable('getSelections');
            if(selects.length>0){
                datas=selects[0];
            }else{
                $.each(cols,function(index,item){
                    datas[item.field]='';
                });
            }
            datas[$('#keyid').val()]=getRandomChars();
            $("#boot_table").bootstrapTable('insertRow',{
                index:$("#boot_table").bootstrapTable('getOptions').totalRows,
                row:datas
            });
        });

        $('#searchID').unbind('click').bind('click',function(){
            $("#boot_table").bootstrapTable('refreshOptions',{
                url:basePath+"/share/findListPage",
                columns:cols
            });
        });
    }
    //查询参数设置
    function queryParam(param){
        var paramConfig={};//查询没有上报的情况
        paramConfig['currPage']=param.pageNumber;
        paramConfig['pageSize']=param.pageSize ;
        //paramConfig['TABLEID']=param.searchText;
        //可以增加排序 map.ORDERBY cols asc desc
        //paramConfig['TABLEID']=param.searchText;
        var inputs=$('#searcformid').find('input');
        $.each(inputs,function(index,item){
            var value=$(item).val();
            var name=$(item).prop('name');
            if(value){
                paramConfig[name]=value;
            }
        });
        param['condition']=JSON.stringify(paramConfig);
        param['tablename']=$('#tablenameid').val();
        //param['methodName']='findBaseInfoOperateList';
        //param["URL"]=basePath+'/share/findListPageSql';
        return param;
    }
    //初始化查询列和查询表名
    function initInfo(){
        var columns=new Array();
        var maindata=ajaxFindListSql('',"findColumnsByTableName",{'NAME':$('#tablenameid').val()});
        var inptuclone=$('#tablenameid').parent().clone(true);
        $('#searcformid').find('input').parent().remove();
        columns.push({field:'RN',
            title:'',
            align:'center',
            checkbox:"true",
            formatter:"checkboxProcess"
        });
        $.each(maindata.result,function(index,item){
            //中文名
            var ename=item.COLUMNENAME.toUpperCase();
            //英文名
            var cname=item.COLUMNNAME;
            //是否为查询条件
            var isFind=item.ISFIND;
            //查询列表是否显示
            var findDisplay=item.FINDDISPLAY;
            //修改是否可编辑
            var modifyDisplay=item.MODIFYDISPLAY;
            var ISKEY=item.ISKEY;
            if(ISKEY=='1'){
                $('#keyid').val(ename);
            }
            var cols={};
            if(findDisplay=='1'){
                //如果允许编辑
                if(modifyDisplay=='1'){
                    cols={field:ename,
                        title:cname,
                        align:'center',
                        editable:{
                            type:'textarea',
                            title:cname
                        }
                    };
                }else{
                    cols={field:ename,
                        title:cname,
                        align:'center'
                    };
                }
                columns.push(cols);
                if(isFind=="1"){
                    inptuclone.find('input').prop('name',ename);
                    inptuclone.find('input').prop('id','');
                    inptuclone.find('input').val('');
                    inptuclone.find('label').html(cname);
                    $('#searcformid button').before(inptuclone.prop('outerHTML'));
                }
            }
        });

        return columns;
    }


    function modifyInfo(){
        var tablename=$('#tablenameid').val();
        var _key=$('#keyid').val();
        if(!tablename || !_key ){
            $.alert('表名或者主键不能为空！');
            return ;
        }
        var datas=$("#boot_table").bootstrapTable('getSelections');
        var modifyArray=new Array();
        $.each(datas,function(index,item){
            delete item.RN;
            //delete item.COLUMNENAME;
            //delete item.COLUMNNAME;
            //item.DISCONTENT=JSON.stringify(item.DISCONTENT);
            modifyArray.push({'key':_key,'value':item});
        });
        var data={};
        data['modifyInfo']=JSON.stringify(modifyArray);
        data['tablename']=tablename;
        var dataUrl=basePath+'/bootInfo/bathModifyBase';
        // 调用后台
        $.ajax({
            url :dataUrl,//后台处理程序
            type:"post",  //数据发送方式
            async:false,   //同步为false,异步为true
            dataType:"text", //接受数据格式
            data:data,
            success: function(result){//执行成功后
                var da=eval('('+result+')');
                resultdata=da;
                if(resultdata.code=='10001'){
                    $.alert('保存成功');
                    $('#searchID').click();
                }else{
                    $.alert('保存失败');
                }
            }
        });
    }
    function addSaveInfo(){
        var tablename=$('#tablenameid').val();
        var _key=$('#keyid').val();
        if(!tablename || !_key ){
            $.alert('表名或者主键不能为空！');
            return ;
        }
        var datas=$("#boot_table").bootstrapTable('getSelections');
        $.each(datas,function(index,item){
            delete item.RN;
            //delete item.COLUMNENAME;
            //delete item.COLUMNNAME;
            //item.DISCONTENT=JSON.stringify(item.DISCONTENT);
            //modifyArray.push({'key':_key,'value':item});
        });
        var data={};
        data['addInfo']=JSON.stringify(datas);
        data['tablename']=tablename;
        var dataUrl=basePath+'/bootInfo/batchInsertData';
        // 调用后台
        $.ajax({
            url :dataUrl,//后台处理程序
            type:"post",  //数据发送方式
            async:false,   //同步为false,异步为true
            dataType:"text", //接受数据格式
            data:data,
            success: function(result){//执行成功后
                var da=eval('('+result+')');
                resultdata=da;
                if(resultdata.code=='10001'){
                    $.alert('保存成功');
                    //$('#tablesearchID').click();
                    $('#searchID').click();
                }else{
                    $.alert('保存失败');
                }
            }
        });
    }
    function checkboxProcess(index,row){
        /* if($.inArray(row.NM,Array.from(overAllIds))!=-1){
            return { checked:true} ;
        } */
    }

    function delBath(){

        var tablename=$('#tablenameid').val();
        var _key=$('#keyid').val();
        if(!tablename || !_key ){
            $.alert('表名或者主键不能为空！');
            return ;
        }
        var datas=$("#boot_table").bootstrapTable('getSelections');
        var array=new Array();
        var isDel=false;//'editable-unsaved';
        $.each(datas,function(index,item){
            array.push({'key':_key,'value':eval('item.'+_key)});
        });
        var data={};
        data['condition']=JSON.stringify(array);
        data['tablename']=tablename;
        var dataUrl=basePath+'/bootInfo/delBathInfo';
        // 调用后台
        $.ajax({
            url :dataUrl,//后台处理程序
            type:"post",  //数据发送方式
            async:false,   //同步为false,异步为true
            dataType:"text", //接受数据格式
            data:data,
            success: function(result){//执行成功后
                var da=eval('('+result+')');
                resultdata=da;
                if(resultdata.code=='10001'){
                    $.alert('删除成功');
                    $('#searchID').click();
                }else{
                    $.alert('删除失败');
                }
            }
        });
    }
</script>
</html>